# vitaCare Prescription Service Bitbucket Pipelines Template.
## Each project will require to vars BASEPATH & PUBLISH_XML_PATH
## You will have to find\replace entires in this file: vitaviews for the name of your project. i.e., vitamed...provided the devs are using the standard template and naming convention
image: mcr.microsoft.com/dotnet/sdk:6.0
clone:
  enabled: true
  lfs: false
  depth: full
  steps:
    - step: &semver_step
        name: Get SemVer
        runs-on: 
          - 'self.hosted'
          - 'linux'
          - "active"
        script:
        - dotnet new tool-manifest --force
        - dotnet tool install GitVersion.Tool --version 5.10.3
        - dotnet tool restore
        - dotnet gitversion /output buildserver
        - source gitversion.properties
        - echo SemVer generated by GitVersion $GITVERSION_FULLSEMVER.$BITBUCKET_BUILD_NUMBER
        artifacts:
          - gitversion.properties
    - step: &build_only_step_database
        name: Build Dacpac Solution
        runs-on:
          - "self.hosted"
          - "windows"
          - "active"
        script:
          - >
            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          - choco feature enable -n allowGlobalConfirmation
          - choco install openjdk
          - cd src/
          - msbuild vps.coracare.vitaviews.database.sln /t:Build /p:Configuration=Release /p:RestorePackages=false
    - step: &update_publish.xml
        name: Update publish.xml
        runs-on: 
          - 'self.hosted'
          - 'linux'
          - "active"
        script:
          - bash run.sh -v
          - cd src/vitaviews/
          - mv vitaviews.publish.xml vitaviews.publish.xml.tmp
        artifacts:
          -  src/vitaviews/vitaviews.publish.xml.tmp
    - step: &build_and_publish_step_database 
        name: Build & Publish Step
        runs-on:
          - "self.hosted"
          - "windows"
          - "active"
        script:
          - >
            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          - choco feature enable -n allowGlobalConfirmation
          - choco install openjdk
          - Remove-Item src/vitaviews/vitaviews.publish.xml
          - cd src/vitaviews/
          - Rename-Item vitaviews.publish.xml.tmp vitaviews.publish.xml
          - cd ../
          - msbuild vps.coracare.vitaviews.database.sln /t:Build /p:Configuration=Release /p:RestorePackages=false
        artifacts:
         - src/vitaviews/bin/Release/**
    - step: &deploy_step
        name: Octopus Pack, Push & Deploy
        image: octopusdeploy/octo:6.17.3-alpine
        runs-on:
          - "self.hosted"
          - "linux"
          - "active"
        script:
          - source gitversion.properties
          - echo Octopus will pack, push and deploy package as version $GITVERSION_FULLSEMVER
          - export VERSION=$GITVERSION_FULLSEMVER.$BITBUCKET_BUILD_NUMBER
          - echo "using $BITBUCKET_DEPLOYMENT_ENVIRONMENT deploy $BITBUCKET_REPO_SLUG."
          - octo pack --id $BITBUCKET_REPO_SLUG.dacpac --version $VERSION --outFolder ./out --basePath $BASEPATH
          - octo push --package ./out/$BITBUCKET_REPO_SLUG.dacpac.$VERSION.nupkg --server $OCTOPUS_SERVER --apiKey $OCTOPUS_APIKEY
          - octo create-release --server $OCTOPUS_SERVER --apiKey $OCTOPUS_APIKEY --project $BITBUCKET_REPO_SLUG --deployto $BITBUCKET_DEPLOYMENT_ENVIRONMENT --packageVersion $VERSION --version $VERSION --enableservicemessages --progress
          - echo export BITBUCKET_DEPLOYMENT_ENVIRONMENT=$BITBUCKET_DEPLOYMENT_ENVIRONMENT >> shared_vars.sh
        artifacts:
          - out/**
          - shared_vars.sh
options:
  max-time: 30
  size: 1x
pipelines:
  branches:
    master: 
      - step: *build_only_step_database
    nerds-dev:
      - step: *semver_step
      - step: *update_publish.xml
      - step: *build_and_publish_step_database
      - step:
          <<: *deploy_step
          deployment: DEV
    runts-dev:
      - step: *semver_step
      - step: *update_publish.xml
      - step: *build_and_publish_step_database
      - step:
          <<: *deploy_step
          deployment: QA
    patch:
      - step: *semver_step
      - step: *update_publish.xml
      - step: *build_and_publish_step_database
      - step:
          <<: *deploy_step
          deployment: PATCH
    cofy-dev:
      - step: *semver_step
      - step: *update_publish.xml
      - step: *build_and_publish_step_database
      - step:
          <<: *deploy_step
          deployment: COFY
    taco-dev:
      - step: *semver_step
      - step: *update_publish.xml
      - step: *build_and_publish_step_database
      - step:
          <<: *deploy_step
          deployment: TACO
  custom:
    manual-deploy:
      - variables:
          - name: BITBUCKET_DEPLOYMENT_ENVIRONMENT
            default: "DEV"
            allowed-values:
              - "DEV"
              - "QA"
              - "UAT"
              - "PATCH"
              - "COFY"
              - "TACO"
              - "INT"
          - name: DROP_DATA
            default: "N"
            allowed-values:
              - "Y"
              - "N"
      - step: *semver_step
      - step: *update_publish.xml
      - step: *build_and_publish_step_database
      - step: *deploy_step
  pull-requests:
    "**":
      - step: *build_only_step_database